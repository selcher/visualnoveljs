/**
 * visual-novel - v0.0.2 - build 2015-05-24 15:05:45
 * Copyright (c) 2014-2015 Selcher;
 * Distributed under the terms of the MIT license.
 */
function VisualNovel(a,b,c,d){return this instanceof VisualNovel?(this.novelId=a,this.novelTitle="",this.novelSubtitle="",this.novelMode="dialog",this.imgPath=d?d:"",this.images=[],this.novelContainerId=null,this.novelTitleContainerId=null,this.novelTitleTextId=null,this.novelSubtitleTextId=null,this.screenStartId=null,this.screenStartMenuButtonContainerId=null,this.screenStartMenuStartButtonId=null,this.novelModeId=null,this.dialogModeId=null,this.dialogButtonId=null,this.dialogImageId=null,this.dialogTextId=null,this.dialogMenuId=null,this.screenCharacterId=null,this.screenSceneId=null,this.screenBgId=null,this.defaultVal={},this.timers={dialog:{text:null}},this.sceneContainer=null,this.sceneFloor=null,this.scenes={text:[],object:[]},this.characterContainer=null,this.characters=[],this.menuChoicesTaken={},this.menuChoices={},this.userInput={},this.screenWidth=b,this.screenHeight=c,this.dialogWidth=b,this.dialogHeight=150,this.dialogPadding={top:10,right:10,bottom:10,left:10},this.dialogBorder={top:10,right:50,bottom:10,left:50},this.dialogTextColor="white",this.dialogBgColor="rgba(0,0,0,0.5)",this.dialogButtonSize={width:40,height:30},this.dialogButtonPos={left:b-this.dialogPadding.right-this.dialogButtonSize.width,bottom:0},this.dialogCharacter=null,this.sceneHeight=this.screenHeight-this.dialogHeight,this.sceneFloorHeight=c>b?c:b,this.sceneFloorWidth=c>b?c:b,this.templates={novelcontainer:["<div class='novel-container unSelectable'>","<div id='{novelId}-screen-start' class='novel screen-start'></div>","<div id='{novelId}-dialog-menu' class='novel dialog-menu'></div>","<div id='{novelId}-dialog-novelmode' class='novel dialog-novelmode'></div>","<div id='{novelId}-dialog-dialogmode' class='novel dialog-dialogmode'></div>","<div id='{novelId}-screen-character' class='novel screen-character'></div>","<div id='{novelId}-screen-scene' class='novel screen-scene'></div>","<div id='{novelId}-screen-bg' class='novel screen-bg'></div>","</div>"],startmenu:["<div id='{novelId}-novelTitleContainer' class='novelTitleContainer'>","<div id='{novelId}-novelTitleText' class='novelTitleText'>{novelTitle}</div>","<div id='{novelId}-novelSubtitleText' class='novelSubtitleText'>{novelSubtitle}</div>","</div>","<div id='{novelId}-startMenuButtonContainer' class='startMenuButtonContainer'>","<button id='{novelId}-startMenuButton' class='startMenuButton' >","START</button>","</div>"],say:["<if={showDialogImage}><img id='{novelId}-dialog-dialogImage' src='{dialogImage}' style='{dialogImageStyle}' /></if>","<div id='{novelId}-dialog-dialogName' class='dialogName' style='{dialogNameStyle}'>{name}</div>","<div id='{novelId}-dialog-dialogText' class='dialogText'>{dialogLine}</div>","<if={showButtonText}><button id='{novelId}-dialog-dialogButton' class='dialogButton' >{dialogButtonText}</button></if>","<if={showButtonImage}><img id='{novelId}-dialog-dialogButton' class='dialogButton' src='{dialogButtonImage}' style='{dialogButtonImageStyle}' /></if>"],userinput:["<div id='userInputContainer' class='userInputContainer'>","<div id='userInputMessage' class='userInputMessage'>{message}</div><hr/><br/>","<input id='{novelId}-userInputText' class='userInputText' type='text' /><br/><br/>","<input type='button' id='{novelId}-userInputButton' class='userInputButton' value='OK' />","</div>"],menuchoice:["<div id='{novelId}-dialogMenuChoiceContainer' class='dialogMenuChoiceContainer'>","<div id='{novelId}-dialogMenuChoiceButtonsContainer' class='dialogMenuChoiceButtonsContainer'>","<foreach={choice in choices}>","<button class='dialogMenuChoiceButton' id='{novelId}-dialogMenuChoiceButton{index}' >","{choice.label}","</button><br/>","</foreach>","</div>","<div id='{novelId}-dialogMenuChoiceImageContainer' class='dialogMenuChoiceImageContainer'>","<if={imgPath}><img src='{imgPath}' style='width:{imgWidth}px;height:{imgHeight}px;' /></if>","</div>","</div>"]},this):new VisualNovel(b,c,d)}function EventTracker(){var a=null;return this instanceof EventTracker?(this.doRepeatEvent=!1,this.eventsInProgress=["main"],this.eventList={main:[]},this.eventId={main:0},this.save={eventsInProgress:[],eventId:{}},a=this):a=new EventTracker,a}function Util(){var a=null;return a=this instanceof Util?this:new Util}function vector2D(a,b,c,d){var e=a[c],f=a[d],g=b[c],h=b[d],i=Math.abs(g-e),j=Math.abs(h-f),k=g>e?1:-1,l=h>f?1:-1,m=j,n=d.slice(),o=k*(i/j),p=l;i>j&&(m=i,n=c.slice(),o=k,p=l*(j/i));var q={axis:n,maxDifference:m};return q[c]=o,q[d]=p,q}function Parser(){var a=null;return this instanceof Parser?(Util.apply(this,arguments),a=this):a=new Parser,a}function ObjectFactory(a){var b=null;if("SceneObject"===a&&(b=SceneObject.apply({},[].slice.call(arguments,1))),"Character"===a&&(b=Character.apply({},[].slice.call(arguments,1))),"SpriteContainer"===a&&(b=new Sprite3D(arguments[1]),b.addChild(Sprite3D.createCenteredContainer())),"ScreenBg"===a&&(b=new Sprite3D(arguments[1]),b.addChild(Sprite3D.createCenteredContainer()),b.sprite=b,b.timer={},b.rotate=Sprite.prototype.rotate,b.rotateTo=Sprite.prototype.rotateTo,b.fade=Sprite.prototype.fade,b.fadeIn=Sprite.prototype.fadeIn,b.fadeOut=Sprite.prototype.fadeOut),"SceneFloor"===a){var c=arguments[1],d=arguments[2],e={x:-(c/2),y:-(d/2),z:-50},f={x:0,y:0},g={x:-90,y:0,z:0};b=new Sprite(c,d,e,f,g)}return"SceneFloorContainer"===a&&(b=(new Sprite3D).setClassName("sceneFloorContainer").setZ(0).rotateX(-20).update()),b}function TemplateFactory(a){var b=null;return this instanceof TemplateFactory?(this.templates=a?a:{},b=this):b=new TemplateFactory(a),b}function Effect(a,b){return this instanceof Effect?(this.screenWidth=a,this.screenHeight=b,this):new Effect}function Sprite(a,b,c,d,e){return this instanceof Sprite?(this.sprite=null,this.init(a,b,c,d,e),this):new Sprite(a,b,c,d,e)}function Character(a,b,c,d,e){return this instanceof Character?(Sprite.apply(this,arguments),this.init(a,b,c,d,e),this):new Character(a,b,c,d,e)}function SceneObject(a,b,c,d,e){return this instanceof SceneObject?(Sprite.apply(this,arguments),this.init(a,b,c,d,e),this):new SceneObject(a,b,c,d,e)}VisualNovel.prototype.init=function(){this.initObjects(),this.initContainers(this.novelId),this.initScreenStart(this.novelId)},VisualNovel.prototype.initObjects=function(){this.util=new Util,this.parser=new Parser,this.eventTracker=new EventTracker,this.templates=new TemplateFactory(this.templates)},VisualNovel.prototype.initContainers=function(a){this.initNovelContainer(a),this.initSceneContainer(),this.initDialogMenuContainer(),this.initNovelModeContainer(),this.initDialogModeContainer(),this.initCharacterContainer(),this.initBGContainer()},VisualNovel.prototype.pause=function(a){function b(){setTimeout(function(){c.eventTracker.nextEvent()},a)}var c=this;this.eventTracker.addEvent("wait",b)},VisualNovel.prototype.repeatEvent=function(){function a(){b.eventTracker.doRepeatEvent=!0}var b=this;this.eventTracker.addEvent("nowait",a)},VisualNovel.prototype.reset=function(){function a(){b.resetNovel(),b.showStartScreen(!0)}var b=this;this.eventTracker.addEvent("wait",a)},VisualNovel.prototype.resetNovel=function(){this.eventTracker.resetEventsInProgress(),this.resetMenuChoices(),this.resetCharacters(),this.resetScenes(),this.resetLoops()},VisualNovel.prototype.setNovelTitle=function(a,b){this.updateNovelTitleModel(a,b),this.updateNovelTitleView(a,b)},VisualNovel.prototype.updateNovelTitleModel=function(a,b){this.novelTitle=a,this.novelSubtitle=b},VisualNovel.prototype.updateNovelTitleView=function(a,b){this.novelTitleTextId.innerHTML=a,this.novelSubtitleTextId.innerHTML=b},VisualNovel.prototype.setNovelTitlePosition=function(a,b){var c=this.util.scalePosition({x:a,y:b},{x:this.screenWidth,y:this.screenHeight}),d=";left:"+c.x+"px;top:"+c.y+"px;";this.novelTitleContainerId.style.cssText+=d},VisualNovel.prototype.setNovelMode=function(a,b,c,d,e){function f(){g.novelMode=a?a:"dialog",h&&(g.setDialogModeContainerSize(b,c),g.setDialogButtonPosition(b-g.dialogPadding.right-g.dialogButtonSize.width)),i&&g.setDialogModeContainerPosition(d,e)}var g=this,h="undefined"!=typeof b&&"undefined"!=typeof c,i="undefined"!=typeof d&&"undefined"!=typeof e;this.eventTracker.addEvent("nowait",f)},VisualNovel.prototype.initNovelContainer=function(a){this.novelContainerId=document.getElementById(a);var b=this.buildNovelContainerContent(a);this.setNovelContainerContent(b),this.updateNovelContainerReference(a),this.setNovelContainerSize(this.screenWidth,this.screenHeight)},VisualNovel.prototype.buildNovelContainerContent=function(a){var b=this.templates.get("novelcontainer");return b=this.parser.parseTemplate(b,{novelId:a})},VisualNovel.prototype.setNovelContainerContent=function(a){this.novelContainerId.innerHTML=a},VisualNovel.prototype.updateNovelContainerReference=function(a){var b=document;this.screenStartId=b.getElementById(a+"-screen-start"),this.novelModeId=b.getElementById(a+"-dialog-novelmode"),this.dialogModeId=b.getElementById(a+"-dialog-dialogmode"),this.dialogMenuId=b.getElementById(a+"-dialog-menu"),this.screenCharacterId=b.getElementById(a+"-screen-character"),this.screenSceneId=b.getElementById(a+"-screen-scene"),this.screenBgId=b.getElementById(a+"-screen-bg")},VisualNovel.prototype.setNovelContainerSize=function(a,b){var c=this.novelContainerId,d=c?c.getElementsByClassName("novel"):[],e=";overflow:hidden;width:"+a+"px;height:"+b+"px;";c.style.cssText+=e,this.util.foreach(d,function(c){e=";width:"+a+"px;height:"+b+"px;",c.style.cssText+=e})},VisualNovel.prototype.initScreenStart=function(a){this.buildStartMenu(a),this.updateStartMenuReference(a),this.showStartScreen(!0),this.addStartMenuButtonHandler()},VisualNovel.prototype.addStartMenuButtonHandler=function(){var a=this;this.screenStartMenuStartButtonId.onclick=function(){a.startNovel()}},VisualNovel.prototype.startNovel=function(){this.showStartScreen(!1),this.eventTracker.startEvent()},VisualNovel.prototype.buildStartMenu=function(a){var b=this.screenStartId,c=this.templates.get("startmenu"),d={novelId:a,novelTitle:this.novelTitle,novelSubtitle:this.novelSubtitle};c=this.parser.parseTemplate(c,d),b.innerHTML=c},VisualNovel.prototype.updateStartMenuReference=function(a){var b=document;this.novelTitleContainerId=b.getElementById(a+"-novelTitleContainer"),this.novelTitleTextId=b.getElementById(a+"-novelTitleText"),this.novelSubtitleTextId=b.getElementById(a+"-novelSubtitleText"),this.screenStartMenuButtonContainerId=b.getElementById(a+"-startMenuButtonContainer"),this.screenStartMenuStartButtonId=b.getElementById(a+"-startMenuButton")},VisualNovel.prototype.showStartScreen=function(a){var b=a?"block":"none";this.screenStartId.style.display=b},VisualNovel.prototype.setStartScreenBgImage=function(a,b,c){var d=this.imgPath+a,e=";background-image:url('"+d+"');background-size:"+b+"px "+c+"px;";this.screenStartId.style.cssText+=e},VisualNovel.prototype.setStartScreenBgColor=function(a){this.screenStartId.style["background-color"]=a},VisualNovel.prototype.setStartScreenMenuBgImage=function(a,b,c){var d=";background-image:url('"+this.imgPath+a+"');background-size:"+b+"px "+c+"px;";this.screenStartMenuButtonContainerId.style.cssText+=d},VisualNovel.prototype.setStartScreenMenuBgColor=function(a){this.screenStartMenuButtonContainerId.style["background-color"]=a},VisualNovel.prototype.setStartScreenMenuPos=function(a,b){var c=a>1?a:a*this.screenHeight,d=b>1?b:b*this.screenWidth,e=";left:"+c+"px;top:"+d+"px;";this.screenStartMenuButtonContainerId.style.cssText+=e},VisualNovel.prototype.initSceneContainer=function(){var a=this.createSceneContainer(this.screenSceneId,this.sceneFloorWidth,this.sceneFloorHeight);this.sceneContainer=a.floorContainer,this.sceneFloor=a.floor},VisualNovel.prototype.createSceneContainer=function(a,b,c){var d=ObjectFactory("SpriteContainer",a),e=d.children[0],f=ObjectFactory("SceneFloor",b,c),g=ObjectFactory("SceneFloorContainer");g.addChild(f.sprite),e.addChild(g);var h={floorContainer:g,floor:f};return h},VisualNovel.prototype.rotateScene=function(a,b,c,d){function e(){f.sceneFloor.rotate(a,b,c,d)}var f=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.moveScene=function(a,b,c,d){function e(){f.sceneFloor.move(a,b,c,d)}var f=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.resetScenes=function(){var a=this.sceneContainer?this.sceneContainer.children:[],b=a.length;if(b>1)for(var c=b-1;c--;)this.sceneContainer.removeChildAt(c+1);this.scenes={text:[],object:[]}},VisualNovel.prototype.initDialogMenuContainer=function(){this.dialogMenuId.style.display="none"},VisualNovel.prototype.initNovelModeContainer=function(){this.novelModeId.style.display="none"},VisualNovel.prototype.initDialogModeContainer=function(){this.setSayDialogDisplay(!1),this.setDialogModeContainerSize(this.dialogWidth,this.dialogHeight),this.setDialogModeContainerPosition(0,this.sceneHeight),this.setDialogTextColor(this.dialogTextColor),this.setDialogBgColor(this.dialogBgColor)},VisualNovel.prototype.setDialogModeContainerSize=function(a,b){var c=this.calculateDialogModeContainerSize(a,b),d=";width:"+c.width+";height:"+c.height+";";this.dialogModeId.style.cssText+=d,this.dialogWidth=a,this.dialogHeight=b},VisualNovel.prototype.calculateDialogModeContainerSize=function(a,b){var c=this.dialogPadding,d=a?a:this.dialogWidth,e=b?b:this.dialogHeight,f={width:d-c.left-c.right+"px",height:e-c.top-c.bottom+"px"};return f},VisualNovel.prototype.setDialogModeContainerPosition=function(a,b){var c=this.util.scalePosition({x:a?a:0,y:b?b:this.sceneHeight},{x:this.screenWidth,y:this.screenHeight}),d=";left:"+c.x+"px;top:"+c.y+"px;";this.dialogModeId.style.cssText+=d},VisualNovel.prototype.setDialogBgImage=function(a,b,c){var d=a?";background-image:url('"+this.imgPath+a+"');":";",e=b&&c?"width:"+b+"px;height: "+c+"px;":"",f=d+e;this.dialogModeId.style.cssText+=f},VisualNovel.prototype.setDialogBgColor=function(a){this.dialogModeId.style["background-color"]=a?a:"black"},VisualNovel.prototype.setDialogTextColor=function(a){this.dialogModeId.style.color=a?a:"white"},VisualNovel.prototype.setDialogBorderStyle=function(a,b,c,d){var e=(this.dialogPadding,a?"url('"+this.imgPath+a+"')":"",c?"string"==typeof c?c:c+"px":"");e=""===e?";":";border-width:"+e+";";var f="border-style:solid;",g=b?b:"rgba( 0, 0, 0, 0.5 )";g="border-color:"+g+";";var h=d?"string"==typeof d?d:d+"px":"";h=""===h?"":"border-radius:"+h+";";var i=e+f+g+h;this.dialogModeId.style.cssText+=i,this.setDialogModeContainerSize(this.dialogWidth,this.dialogHeight)},VisualNovel.prototype.updateDialogBorderStyle=function(a,b,c,d){function e(){f.setDialogBorderStyle(a,b,c,d)}var f=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.setDialogButtonPosition=function(a,b){var c=this.dialogButtonPos;"undefined"!=typeof a&&(c.left=a),"undefined"!=typeof b&&(c.bottom=b)},VisualNovel.prototype.updateDialogButtonPosition=function(a){var b="object"==typeof a?!0:!1,c=b&&a.dialog&&a.dialog.button?a.dialog.button:null,d=c&&c.width;if(d){var e=this.dialogPadding;this.setDialogButtonPosition(this.dialogWidth-e.right-e.left-c.width)}},VisualNovel.prototype.refreshDialogButtonPositionView=function(){var a=this.dialogButtonPos,b=";left:"+a.left+"px;bottom:"+a.bottom+"px;";this.dialogButtonId.style.cssText+=b},VisualNovel.prototype.updateDialogButtonListeners=function(a,b){var c=this,d="object"==typeof a?!0:!1,e=d&&a.dialog?a.dialog:null,f=e&&a.dialog.button?a.dialog.button:null,g=this.dialogButtonId,h=this.dialogImageId,i=f&&f.bgColor&&f.bgColorHover,j=f&&f.bgColorHover?f.bgColorHover:"transparent",k=i?function(){g.style["background-color"]=j}:function(){},l=f&&f.bgColor?f.bgColor:"transparent",m=i?function(){g.style["background-color"]=l}:function(){},n=f&&f.image&&f.imageHover,o=f&&f.imageHover?this.imgPath+f.imageHover:"",p=n?function(){g.setAttribute("src",o)}:function(){},q=f&&f.image?this.imgPath+f.image:"",r=n?function(){g.setAttribute("src",q)}:function(){};g.onmouseover=function(){k(),p()},g.onmouseleave=function(){m(),r()};var s=function(){},t=null,u=e&&e.image?this.imgPath+e.image:"",v=e&&e.nextImage?this.imgPath+e.nextImage:"",w=e&&e.imageDelay?e.imageDelay:5e3;e&&e.nextImage&&(t=setInterval(function(){h.setAttribute("src",v),setTimeout(function(){h.setAttribute("src",u)},200)},w),s=function(){window.clearInterval(t)}),this.dialogButtonId.onclick=function(){b(),c.eventTracker.nextEvent(),s()}},VisualNovel.prototype.initCharacterContainer=function(){var a=this.screenCharacterId,b=";display:none;width:"+this.screenWidth+"px;height:"+this.screenHeight+"px;";a.style.cssText+=b,this.characterContainer=ObjectFactory("SpriteContainer",a)},VisualNovel.prototype.initBGContainer=function(){this.screenBgId=ObjectFactory("ScreenBg",this.screenBgId)},VisualNovel.prototype.setBgImage=function(a,b,c,d,e,f){function g(){var d=h.screenBgId;d.setPosition(0,0,0).setSize(b,c).setCSS("background-image","url('"+h.imgPath+a+"')"),e&&f&&d.setCSS("background-size",e+"px "+f+"px"),requestAnimationFrame(function(){d.update()})}var h=this;this.eventTracker.addEvent("nowait",g)},VisualNovel.prototype.setBgColor=function(a){function b(){c.screenBgId.style["background-color"]=a}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.setBgSize=function(a,b,c,d){function e(){if(c){var d=f.getBgSize(),e={width:a-d.width,height:b-d.height},g=Date.now(),h=c,i=function(){var a=Date.now(),b=(a-g)/h;f.setBgSizeTo(d.width+b*e.width,d.height+b*e.height),1>=b&&requestAnimationFrame(i)};requestAnimationFrame(i)}else f.setBgSizeTo(a,b);f.screenBgId.update()}var f=this;this.eventTracker.addEvent("nowait",e,d)},VisualNovel.prototype.getBgSize=function(){var a=this.screenBgId;return{width:a.width,height:a.height}},VisualNovel.prototype.setBgSizeTo=function(a,b){this.screenBgId.setSize(a,b).setCSS("background-size",a+"px "+b+"px")},VisualNovel.prototype.setBgPosition=function(a,b,c,d){function e(){var d=f.getBgPosition(),e={x:a-d.x,y:b-d.y},g=f.screenBgId;if(c){var h=Date.now(),i=c,j=function(){var a=Date.now(),b=(a-h)/i;g.x=d.x+b*e.x,g.y=d.y+b*e.y,g.update(),1>=b&&requestAnimationFrame(j)};requestAnimationFrame(j)}else requestAnimationFrame(function(){g.x=d.x+e.x,g.y=d.y+e.y,g.update()})}var f=this;this.eventTracker.addEvent("nowait",e,d)},VisualNovel.prototype.getBgPosition=function(){var a=this.screenBgId,b={x:a.x,y:a.y};return b},VisualNovel.prototype.rotateBg=function(a,b,c,d,e){function f(){g.screenBgId.rotate(a,b,c,d,e),g.screenBgId.update()}var g=this;this.eventTracker.addEvent("nowait",f,0)},VisualNovel.prototype.rotateBgTo=function(a,b,c,d,e){function f(){g.screenBgId.rotateTo(a,b,c,d,e),g.screenBgId.update()}var g=this;this.eventTracker.addEvent("nowait",f,0)},VisualNovel.prototype.stopRotateBg=function(a){function b(){window.clearInterval(c.screenBgId.timer.rotate)}var c=this;this.eventTracker.addEvent("nowait",b,a)},VisualNovel.prototype.fadeBg=function(a,b){function c(){var c=d.screenBgId;"in"===a&&c.fadeIn(b),"out"===a&&c.fadeOut(b)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.resetBg=function(a,b){function c(){var b=d.screenBgId;"rotate"==a&&(window.clearInterval(b.timer.rotate),b.setRotation(0,0,0).update()),"fade"==a&&b.fadeIn(0)}var d=this;this.eventTracker.addEvent("nowait",c,b)},VisualNovel.prototype.addObjectToScene=function(a,b,c,d,e,f){function g(){var d=b.width,g=b.height,i=h.util.scalePosition({x:c.x,y:c.y,z:c.z},{x:h.sceneFloorWidth,y:-h.sceneFloorHeight,z:h.sceneFloorHeight}),j=ObjectFactory("SceneObject",d,g,i);j.setBackground(d,g,b.path?h.imgPath+b.path:"",b.color),e&&j.fadeIn(f),j.name=a,h.sceneFloor.sprite.addChild(j.sprite),h.scenes.object.push(j)}var h=this;this.eventTracker.addEvent("nowait",g,d)},VisualNovel.prototype.moveSceneObject=function(a,b,c,d,e,f){function g(){h.setSceneObjectPosition(a,b,c,d,e)}var h=this;this.eventTracker.addEvent("nowait",g,f?f:0)},VisualNovel.prototype.setSceneObjectPosition=function(a,b,c,d,e){var f=this.util,g=f.getObjectInList(this.scenes.object,"name",a),h=g.obj,i=h.sprite,j=f.scalePosition({x:b?b:i.x,y:c?c:i.y,z:d?d:i.z},{x:this.screenWidth,y:this.screenHeight,z:this.screenHeight});e?h.move(j.x,j.y,j.z,e):h.moveTo(j.x,j.y,j.z)},VisualNovel.prototype.rotateSceneObject=function(a,b,c,d,e){function f(){g.setSceneObjectRotation(a,b,c,d,e)}var g=this;this.eventTracker.addEvent("nowait",f)},VisualNovel.prototype.setSceneObjectRotation=function(a,b,c,d,e){var f=this.util.getObjectInList(this.scenes.object,"name",a),g=f.obj;e?g.rotate(b,c,d,e):g.rotateTo(b,c,d)},VisualNovel.prototype.fadeSceneObject=function(a,b,c){function d(){e.setSceneObjectFade(a,b,c)}var e=this;this.eventTracker.addEvent("nowait",d)},VisualNovel.prototype.setSceneObjectFade=function(a,b,c){var d=this.util.getObjectInList(this.scenes.object,"name",a),e=d.obj,f="string"==typeof b?b.toLowerCase():"";"in"===f&&e.fadeIn(c),"out"===f&&e.fadeOut(c)},VisualNovel.prototype.setSceneObjectStyle=function(a,b){var c=this.util.getObjectInList(this.scenes.object,"name",a),d=c.obj;d.sprite.children[0].style.cssText+=b},VisualNovel.prototype.resetSceneObject=function(a,b){function c(){var c=d.util.getObjectInList(d.scenes.object,"name",a),e=c.obj,f=e?e.sprite.children[0].timer:null,g=f?f[b]:null;e&&g&&"rotate"==b&&(window.clearInterval(g),g=null)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.removeSceneObject=function(a){function b(){var b=c.util.getObjectInList(c.scenes.object,"name",a),d=b.id;c.sceneFloor.sprite.removeChildAt(d),c.scenes.object.splice(d,1)}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.addTextToScene=function(a,b,c,d){function e(){var d=c.width?c.width:0,e=c.height?c.height:0,g=f.util.scalePosition({x:c.x,y:c.y,z:c.z},{x:f.sceneFloorWidth,y:-f.sceneFloorHeight,z:f.sceneFloorHeight}),h=ObjectFactory("SceneObject",d,e,g);h.sprite.children[0].setInnerHTML(b),c.size&&h.sprite.setCSS("font-size",c.size+"px"),c.color&&h.sprite.setCSS("color",c.color),(c.bgColor||c.bgImage)&&h.setBackground(d,e,c.bgImage?f.imgPath+c.bgImage:null,c.bgColor?c.bgColor:null),c.fade&&h.fadeIn(c.fade),h.name=a,f.sceneFloor.sprite.addChild(h.sprite),f.scenes.object.push(h)}var f=this;this.eventTracker.addEvent("nowait",e,d)},VisualNovel.prototype.fadeSceneText=function(a,b,c){this.fadeSceneObject(a,b,c)},VisualNovel.prototype.moveSceneText=function(a,b,c,d,e,f){this.moveSceneObject(a,b,c,d,e,f)},VisualNovel.prototype.rotateSceneText=function(a,b,c,d,e){this.rotateSceneObject(a,b,c,d,e)},VisualNovel.prototype.removeSceneText=function(a){this.removeSceneObject(a)},VisualNovel.prototype.moveCharacter=function(a,b,c,d){function e(){var e=f.getCharacter(a.name),g=e.sprite,h={x:"undefined"!=typeof b?b>1||-1>b?b:b*f.screenWidth:g.x,y:"undefined"!=typeof c?c>1||-1>c?c:c*f.screenHeight:g.y};d?e.move(h.x,h.y,0,d):requestAnimationFrame(function(){g.x=h.x,g.y=h.y,g.update()})}var f=this;this.eventTracker.addEvent("nowait",e)},VisualNovel.prototype.fadeCharacter=function(a,b,c,d,e){function f(){var f=g.getCharacter(a.name);"in"==b?f.fadeIn(c,d,e):"out"==b&&f.fadeOut(c,d,e)}var g=this;this.eventTracker.addEvent("nowait",f)},VisualNovel.prototype.flipCharacter=function(a){function b(){var b=c.getCharacter(a.name),d=b.sprite,e=d.scaleX>0?-1:1;d.setScaleX(e).update()}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.addCharacter=function(a,b,c){function d(){g.screenCharacterId.style.display="block";var b=a.width/2,c=g.screenHeight-a.height+g.screenHeight*a.pos.y,d=g.screenWidth*a.pos.x,e={x:Math.floor(d),y:Math.floor(c),z:0},f={x:b,y:0,z:0},h=ObjectFactory("Character",a.width,a.height,e,f);return h.setBackground(a.width,a.height,g.getCharacterImage(a)),h.name=a.name,h}function e(a){g.characterContainer.addChild(a.sprite),g.characters.push(a)}function f(){var a=d();c&&a.fadeIn(b),e(a)}var g=this;this.eventTracker.addEvent("nowait",f,b)},VisualNovel.prototype.getCharacter=function(a){var b=this.util.getObjectInList(this.characters,"name",a);return b.obj},VisualNovel.prototype.getCharacterImage=function(a,b){var c=this.imgPath,d=a&&a.image?a.image:null;return d&&"object"==typeof d?(d=b?d[b]:d["default"],d="object"==typeof d?{src:c+d.src,position:d.position}:c+d):d&&(d=c+d),d},VisualNovel.prototype.changeCharacterImage=function(a,b){function c(){d.setCharacterImage(a,b)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.setCharacterImage=function(a,b){var c=this.getCharacter(a.name),d=this.getCharacterImage(a,b);requestAnimationFrame("object"==typeof d?function(){c.sprite.setCSS("background-image","url('"+d.src+"')"),c.sprite.setCSS("background-position",d.position)}:function(){c.sprite.setCSS("background-image","url('"+d+"')")})},VisualNovel.prototype.removeCharacter=function(a,b,c){function d(){var b=f.util.getObjectInList(f.characters,"name",a.name),c=b.id;f.characterContainer.removeChildAt(c+1),f.characters.splice(c,1)}function e(){if(c){var e=f.getCharacter(a.name);e.fadeOut(b)}f.eventTracker.delayCallback(b,d)}var f=this;this.eventTracker.addEvent("nowait",e,b)},VisualNovel.prototype.removeAllCharacter=function(a){function b(){d.resetCharacters()}function c(){d.eventTracker.delayCallback(a,b)}var d=this;this.eventTracker.addEvent("nowait",c,a)},VisualNovel.prototype.resetCharacters=function(){for(var a=this.characterContainer?this.characterContainer.children:[],b=a.length,c=b-1;c>=1;c--)this.characterContainer.removeChildAt(c);this.characters=[]},VisualNovel.prototype.showTextByChar=function(a,b,c){b<a.length?(this.setSayDialogText(a[b++],!0),this.timers.dialog.text=setTimeout(function(){this.showTextByChar(a,b,c)}.bind(this),c)):this.timers.dialog.text=null},VisualNovel.prototype.sayLine=function(a,b,c){function d(){var d=e.novelMode;if(e.setSayDialogDisplay(!0,d),e.buildSayDialog(a,f?"":b,g,d),e.updateSayDialogReference(e.novelId),h&&(e.updateSayDialogButtonReference(e.novelId),e.updateDialogButtonPosition(a),e.refreshDialogButtonPositionView(a),e.updateDialogButtonListeners(a,function(){var a=e.timers.dialog.text;a&&(clearTimeout(a),a=null)})),f){var i=e.util.replaceVariablesInText(b,e.userInput);e.showTextByChar(i,0,c.interval)}}var e=this,f="object"==typeof c,g=c,h="undefined"==typeof c;f&&(g=c.interval*b.length+(c.delay?c.delay:0),c.button&&(g=0,h=!0)),this.eventTracker.addEvent(g?"nowait":"wait",d,g)},VisualNovel.prototype.sayLineExtend=function(a,b){function c(){d.setSayDialogText(a,!0)}var d=this;this.eventTracker.addEvent(b?"nowait":"wait",c,b)},VisualNovel.prototype.sayMultipleLines=function(a,b){var c=this.util,d=b.length,e=[],f=[],g=null;c.foreach(b,function(a,c){"string"==typeof a&&(f.push(a),g=c+1,d>g&&"number"==typeof b[g]&&f.push(b[g]),d>g&&"boolean"==typeof b[g]?f.push(0,b[g]):d>g+1&&"boolean"==typeof b[g+1]&&f.push(b[g+1]),d>g&&"object"==typeof b[g]&&f.push(b[g]),e.push(f)),f=[]}),c.foreach(e,function(b){if("boolean"==typeof b[b.length-1])if(0===b[1]){var c=f.join("")+b[0];f=[],this.sayLine(a,c)}else f.push(b[0]),this.sayLineExtend.apply(this,b);else"object"==typeof b[1]?this.sayLine(a,b[0],b[1]):(b[1]?f.push(b[0]):f=[],b.unshift(a),this.sayLine.apply(this,b))}.bind(this))},VisualNovel.prototype.say=function(a,b,c){var d=arguments.length,e="object"==typeof a,f="string"==typeof a,g=e||f;g&&"string"==typeof b&&(this.dialogCharacter=a,this.sayLine(a,b,c)),g&&this.util.isArray(b)&&(this.dialogCharacter=a,this.sayMultipleLines(a,b)),f&&(1===d||2===d&&"number"==typeof b)&&this.sayLine(this.dialogCharacter,a,b)},VisualNovel.prototype.buildSayDialog=function(a,b,c,d){var e=this.getSayTemplate(a,b,c);this.setSayDialogContainer(e,d)},VisualNovel.prototype.getSayTemplate=function(a,b,c){var d=this.getSayTemplateVariables(a,b,c),e=this.templates.get("say");return e=this.parser.parseTemplate(e,d)},VisualNovel.prototype.getSayTemplateVariables=function(a,b,c){var d="object"==typeof a?a.name:a,e="object"==typeof a?a.nameStyle:"",f=this.util.replaceVariablesInText(b,this.userInput),g=a.dialog,h=g?!0:!1,i="",j="",k="",l="",m="",n=c?!1:!0,o="OK",p=!1,q="",r="",s="";if(h){i=g.image?this.imgPath+g.image:"",j=g.width?"width:"+g.width+"px;":"",k=g.height?"height:"+g.height+"px;":"",l=g.location?"float:"+g.location+";":"",m=l?"left"==l?"margin-right:10px;":"margin-left:10px;":"";var t=g.button;p=c?!1:t&&t.image?t.image:!1,q=p?this.imgPath+t.image:"",r=p?"width:"+t.width+"px;":"",s=p?"height:"+t.height+"px;":"",n=c||p?!1:t&&t.text?t.text:!0,o=t&&t.text?t.text:"OK"}var u={novelId:this.novelId,name:d,dialogNameStyle:e,dialogLine:f,showDialogImage:h,dialogImage:i,dialogImageStyle:l+j+k+m,showButtonText:n,dialogButtonText:o,showButtonImage:p,dialogButtonImage:q,dialogButtonImageStyle:r+s};return u},VisualNovel.prototype.setSayDialogContainer=function(a,b){var c=b?b:this.novelMode,d="novel"==c?"novelModeId":"dialogModeId";this[d].innerHTML=a},VisualNovel.prototype.setSayDialogText=function(a,b){this.dialogTextId.innerHTML=b?this.dialogTextId.innerHTML+a:a},VisualNovel.prototype.updateSayDialogReference=function(a){var b=document;this.dialogImageId=b.getElementById(a+"-dialog-dialogImage"),this.dialogTextId=b.getElementById(a+"-dialog-dialogText")},VisualNovel.prototype.updateSayDialogButtonReference=function(a){this.dialogButtonId=document.getElementById(a+"-dialog-dialogButton")},VisualNovel.prototype.setSayDialogDisplay=function(a,b){var c=b?b:this.novelMode,d=a?"block":"none";"dialog"==c&&(this.dialogModeId.style.display=d,this.novelModeId.style.display="none"),"novel"==c&&(this.dialogModeId.style.display="none",this.novelModeId.style.display=d)},VisualNovel.prototype.showSayDialog=function(a){function b(){c.setSayDialogDisplay(a,c.novelMode)}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.input=function(a,b){function c(){d.dialogMenuId.style.display="block",d.buildUserInputContainer(b),d.updateUserInputReference(d.novelId),d.userInputButtonId.onclick=function(){d.getInput(a)}}var d=this;this.eventTracker.addEvent("wait",c)},VisualNovel.prototype.buildUserInputContainer=function(a){this.dialogMenuId.innerHTML=this.getUserInputTemplate(a)},VisualNovel.prototype.getUserInputTemplate=function(a){var b={novelId:this.novelId,message:a},c=this.templates.get("userinput");return c=this.parser.parseTemplate(c,b)},VisualNovel.prototype.updateUserInputReference=function(a){var b=document;this.userInputTextId=b.getElementById(a+"-userInputText"),this.userInputButtonId=b.getElementById(a+"-userInputButton")},VisualNovel.prototype.getInput=function(a){var b=this.userInputTextId;this.userInput[a]=b.value,this.dialogMenuId.style.display="none",this.eventTracker.nextEvent()},VisualNovel.prototype.setInput=function(a,b){a&&(this.userInput[a]=b)},VisualNovel.prototype.setValue=function(a,b){function c(){d.setInput(a,b)}var d=this;this.eventTracker.addEvent("nowait",c)},VisualNovel.prototype.getValue=function(a){return this.userInput[a]},VisualNovel.prototype.resetNovelDialogText=function(){this.novelModeId.innerHTML="",this.dialogModeId.innerHTML=""},VisualNovel.prototype.addCondition=function(a,b,c,d,e){function f(){var f=!1,h=g.userInput;"="==b&&(f=h[a]==c),">"==b&&(f=h[a]>c),"<"==b&&(f=h[a]<c),"!="==b&&(f=h[a]!=c);var i=g.eventTracker,j=i.eventsInProgress.length,k=i.eventsInProgress[j-1]+"-condition-"+j;i.addNewEventInProgress(k),f?d():e(),g.eventTracker.startEvent()}var g=this;this.eventTracker.addEvent("wait",f)},VisualNovel.prototype.choice=function(a,b,c,d){function e(){f.dialogMenuId.style.display="block";for(var e=b.length,g=e,h=[];g--;)h.unshift(b[g]);f.menuChoices[a]=h,f.buildMenuChoices(b,d),f.updateMenuChoicesReference(f.novelId),f.addMenuChoicesHandler(a,e),c&&f.setMenuChoicesPosition(c.x,c.y),f.eventTracker.addNewEventInProgress(a)}var f=this;this.eventTracker.addEvent("wait",e)},VisualNovel.prototype.buildMenuChoices=function(a,b){var c=b?b:{image:"",width:0,height:0},d=this.imgPath+c.image,e=this.getMenuChoicesTemplate(a,d,c.width,c.height);this.dialogMenuId.innerHTML=e},VisualNovel.prototype.getMenuChoicesTemplate=function(a,b,c,d){var e={novelId:this.novelId,choices:a,imgPath:b,imgWidth:c,imgHeight:d},f=this.templates.get("menuchoice");return f=this.parser.parseTemplate(f,e)
},VisualNovel.prototype.updateMenuChoicesReference=function(){this.dialogMenuChoiceContainerId=document.getElementById(this.novelId+"-dialogMenuChoiceContainer")},VisualNovel.prototype.addMenuChoicesHandler=function(a,b){for(var c=this,d=this.novelId,e=function(b){var d=b;return function(){c.dialogMenuId.style.display="none",c.performMenuChoice(a,d)}},f=b;f--;)document.getElementById(d+"-dialogMenuChoiceButton"+f).onclick=e(f)},VisualNovel.prototype.performMenuChoice=function(a,b){var c=this.menuChoices[a][b];this.menuChoicesTaken[a]=c;var d=c.action;d(),this.resetMenuChoicesForEvent(a),this.eventTracker.startEvent()},VisualNovel.prototype.setMenuChoicesPosition=function(a,b){var c=this.util.scalePosition({x:a,y:b},{x:this.screenWidth,y:this.screenHeight});this.dialogMenuChoiceContainerId.style.cssText+=";left:"+c.x+"px;top:"+c.y+"px;"},VisualNovel.prototype.resetMenuChoicesForEvent=function(a){function b(){c.menuChoices[a]=[]}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.resetMenuChoices=function(){this.menuChoices={},this.menuChoicesTaken={}},VisualNovel.prototype.loop=function(a,b,c,d){if(c){var e=this,f=d?d:100,g=function(){if(e.timers[a]&&(e.clearLoop(a),e.timers[a]=null),b===!0)e.timers[a]={type:"interval",timer:setInterval(function(){c()},f)};else if(b>0){var d=b,g=function(){c(),d--,h()},h=function(){e.timers[a].timer=d?setTimeout(g,f):null};e.timers[a]={type:"timeout",timer:null},h()}else c()};this.eventTracker.addEvent("nowait",g)}},VisualNovel.prototype.clearLoop=function(a){function b(){c.clearTimer(a)}var c=this;this.eventTracker.addEvent("nowait",b)},VisualNovel.prototype.clearTimer=function(a){var b=this.timers[a];b&&("timeout"===b.type?clearTimeout(b.timer):"interval"===b.type&&clearInterval(b.timer),this.timers[a]=null)},VisualNovel.prototype.resetLoops=function(){var a=this.timers,b=null;for(var c in a)b=a[c]?a[c].type:null,!b||"timeout"!==b&&"interval"!==b||this.clearTimer(c)},EventTracker.prototype.addEvent=function(a,b,c){var d=this.eventsInProgress,e=d[d.length-1];this.eventList[e].push({type:a,event:b,delay:c?c:0})},EventTracker.prototype.addNewEventInProgress=function(a){this.eventsInProgress.push(a),this.eventList[a]=[],this.eventId[a]=0},EventTracker.prototype.startEvent=function(){var a=this,b=this.eventsInProgress,c=b[b.length-1],d=this.eventList[c],e=this.eventId[c],f=d[e],g=f.type,h=f.delay;f.event(),this.delayCallback(h,function(){"nowait"==g&&a.nextEvent()})},EventTracker.prototype.nextEvent=function(){var a=this.eventsInProgress,b=a.length,c=a[b-1],d=this.eventList[c],e=this.eventId;e[c]+=1;var f=e[c];f<d.length?this.startEvent():1==b||(a.pop(),this.doRepeatEvent?(this.doRepeatEvent=!1,this.startEvent()):this.nextEvent())},EventTracker.prototype.resetEventsInProgress=function(){this.eventsInProgress=["main"],this.eventId={main:0}},EventTracker.prototype.delayCallback=function(a,b){a?setTimeout(function(){b()},a):b()},Util.prototype.getObjectInList=function(a,b,c){for(var d={id:null,obj:null},e=a?a:[],f=e.length;f--;)e[f][b]==c&&(d={id:f,obj:e[f]});return d},Util.prototype.scalePosition=function(a,b){var c=a.x,d=a.y,e=a.z,f={x:c>1||-1>c?c:c*b.x,y:d>1||-1>d?d:d*b.y,z:e>1||-1>e?e:e*b.z};return f},Util.prototype.foreach=function(a,b,c){for(var d=a.length;d--;)c?b.call(c,a[d],d):b(a[d],d)},Util.prototype.replaceVariablesInText=function(a,b){var c=a+"",d="",e="",f=null;for(d in b)e=b[d],f=new RegExp("{"+d+"}","gi"),c=c.replace(f,e);return c},Util.prototype.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)},Parser.prototype=Object.create(Util.prototype),Parser.prototype.constructor=Parser,Parser.prototype.parseTemplate=function(a,b){return a=this.parseConditionsInTemplate(a,b),a=this.replaceVariablesInText(a,b),a=this.parseLoopsInTemplate(a,b)},Parser.prototype.parseConditionsInTemplate=function(a,b){var c=a.slice(),d=[],e=c.split(/(<\s*if\s*[^>]*>(.|\n)*?<\s*\/\s*if>)/i);return this.foreach(e,function(a){""!==a&&">"!==a&&d.unshift(a)}),d.length>1&&this.foreach(d,function(a,c){var e=a.replace(/<if={(.*)}>.*<\/if>/i,"$1"),f=b[e],g=void 0===f?e:f?a.replace(/<if={.*}>(.*)<\/if>/i,"$1"):"";d[c]=g.slice()},this),c=d.join("")},Parser.prototype.parseLoopsInTemplate=function(a,b){var c=a.slice(),d=c.match(/<foreach={.*}>.*<\/foreach>/gi);if(d&&d.length>0){var e=[];this.foreach(d,function(a){var c=[],d=a.replace(/<foreach={.*}>(.*)<\/foreach>/gi,"$1"),f=a.replace(/<foreach={(.*)}>.*<\/foreach>/gi,"$1");f=f.split(" ");var g=f[2],h=f[0];this.foreach(b[g],function(a,b){var e=d.replace(/{index}/gi,b),f=new RegExp("{"+h+".(.*)}","gi");e=e.replace(f,"{$1}"),e=this.replaceVariablesInText(e,a),c.unshift(e)},this),e.push(c.join(""))},this),this.foreach(e,function(a){c=c.replace(/<foreach={.*}>.*<\/foreach>/i,a)})}return c},TemplateFactory.prototype.get=function(a){var b=this.templates,c=b[a]?b[a].join(""):"";return c},TemplateFactory.prototype.set=function(a,b){return this.templates[a]=b,this},Effect.prototype.perform=function(a,b,c,d,e){null===b.timer&&(b.timer={}),this[a]&&this[a](b,c,d,e)},Effect.prototype.fadeIn=function(a,b,c,d){var e=d&&d.step?d.step:1,f=d&&"undefined"!=typeof d.from&&d.from>=0?d.from:0,g=d&&"undefined"!=typeof d.to&&d.to>=0?d.to:100;this.fade(a,c,f,g,e)},Effect.prototype.fadeOut=function(a,b,c,d){var e=d&&d.step?d.step:-1,f=d&&"undefined"!=typeof d.from&&d.from>=0?d.from:100,g=d&&"undefined"!=typeof d.to&&d.to>=0?d.to:0;this.fade(a,c,f,g,e)},Effect.prototype.fade=function(a,b,c,d,e){var f=this,g=0>e?-1:1,h=c+g,i=0>e?h>=d&&c>=h:h>=c&&d>=h;i&&(a.setOpacity(h/100),a.timer.fade=setTimeout(function(){f.fade(a,b,h,d,e)},b/100))},Effect.prototype.move=function(a,b,c,d){var e=this,f=d.x,g=d.y,h=d.z,i={x:f?f>1||-1>f?f:f*e.screenWidth:a.x,y:g?g>1||-1>g?g:g*e.screenHeight:a.y,z:h?h>1||-1>h?h:h*e.screenHeight:a.x},j={x:f?Math.abs(i.x-a.x):0,y:g?Math.abs(i.y-a.y):0,z:h?Math.abs(i.z-a.z):0};if(null===a.moveStep){var k={x:f?a.x<i.x?j.x/100:-j.x/100:0,y:g?a.y<i.y?j.y/100:-j.y/100:0,z:h?a.z<i.z?j.z/100:-j.z/100:0};k.x=f?a.x==i.x?0:Math.round(k.x):0,k.y=g?a.y==i.y?0:Math.round(k.y):0,k.z=h?a.z==i.z?0:Math.round(k.z):0,a.moveStep=k}var l=a.moveStep,m=l.x>0?a.x<i.x:a.x>i.x,n=l.y>0?a.y<i.y:a.y>i.y,o=l.z>0?a.z<i.z:a.z>i.z;m||n||o?(a.x=f?a.x+l.x:a.x,a.y=g?a.y+l.y:a.y,a.z=h?a.z+l.z:a.z,a.update(),a.timer.move=setTimeout(function(){e.move(a,b,c,d)},c/100)):a.moveStep=null},Effect.prototype.rotate=function(a,b,c,d){var e=d.axis,f=d.angle,g=a,h=null;"y"==e&&(h=function(){g.rotateY(f)}),"z"==e&&(h=function(){g.rotateZ(f)}),a.timer.rotate=c>=0?setTimeout(function(){h(),g.update()},c):setInterval(function(){h(),g.update()},-c)},Sprite.prototype.init=function(a,b,c,d,e){var f=this.createSprite(a,b,c,d,e);this.sprite=f},Sprite.prototype.createSprite=function(a,b,c,d,e){var f=c,g=d.x,h=d.y,i=d.z,j=(new Sprite3D).setClassName("sprite").setSize(a,b).setTransformOrigin(g,h,i).setPosition(f.x,f.y,f.z).rotateX(e&&e.x?e.x:0).rotateY(e&&e.y?e.y:0).rotateZ(e&&e.z?e.z:0).setRotateFirst(!0);return j.setCSS("-webkit-transform-origin",g+"px "+h+"px").update(),j.timer={},j},Sprite.prototype.setBackground=function(a,b,c,d){var e=a&&b?"background-size:"+a+"px "+b+"px;":"",f=c?"background-image:url('"+c+"');":"",g=d?"background-color:"+d+";":"",h=e||f||g?";":"";this.sprite.style.cssText+=h+e+f+g},Sprite.prototype.move=function(a,b,c){var d=this.sprite,e={x:d.x,y:d.y,z:d.z},f={x:a-d.x,y:b-d.y,z:c-d.z},g=Date.now(),h=500,i=function(){var a=Date.now(),b=(a-g)/h;d.x=e.x+Math.floor(b*f.x),d.y=e.y+Math.floor(b*f.y),d.update(),1>=b&&requestAnimationFrame(i)};requestAnimationFrame(i)},Sprite.prototype.moveTo=function(a,b,c,d){var e=d?d:this.sprite;e.x=a,e.y=b,e.z=c,e.update()},Sprite.prototype.rotate=function(a,b,c,d,e){var f=e?e:this.sprite,g=function(){},h=c?c:0;a&&(g=function(){f["rotate"+a.toUpperCase()](b).update()}),f.timer.rotate=d?setInterval(function(){g()},h):setTimeout(function(){g()},h)},Sprite.prototype.rotateTo=function(a,b,c,d){var e=this,f=d?d:this.sprite,g=a.toUpperCase(),h=f["rotation"+g];if(h!=b){var i=b>=0?1:-1,j=function(){f["setRotation"+g](h+i).update()};f.timer.rotate=setTimeout(function(){j(),e.rotateTo(a,b,c,d)},c?c:0)}else f.timer.rotate=null},Sprite.prototype.fade=function(a,b,c,d){var e=b-a,f=this.sprite,g=Date.now(),h=d,i=function(){var b=Date.now(),c=(b-g)/h,d=a+c*e;f.setOpacity(d/100),1>=c&&requestAnimationFrame(i)};requestAnimationFrame(i)},Sprite.prototype.fadeIn=function(a,b,c){var d=b&&b>0?b:0,e=c&&c>0?c:100;this.fade(d,e,1,a)},Sprite.prototype.fadeOut=function(a,b,c){var d=b&&b>0?b:100,e=c&&c>0?c:0;this.fade(d,e,-1,a)},Character.prototype=Object.create(Sprite.prototype),Character.prototype.constructor=Character,Character.prototype.setBackground=function(a,b,c,d){var e="",f="";"object"==typeof c?(f=c&&c.src?"background-image:url('"+c.src+"');":"",f+=f&&c.position?"background-position:"+c.position+";":""):(e=a&&b?"background-size:"+a+"px "+b+"px;":"",f=c?"background-image:url('"+c+"');":f);var g=d?"background-color:"+d+";":"",h=e||f||g?";":"";this.sprite.style.cssText+=h+e+f+g},SceneObject.prototype=Object.create(Sprite.prototype),SceneObject.prototype.constructor=SceneObject,SceneObject.prototype.init=function(a,b,c){var d={x:c.x-25,y:c.z,z:c.y},e={x:c.x+a/2,y:0},f=this.createSprite(50,50,d,e);d={x:-(a/2)+25,y:-b,z:0},e={x:25,y:0,z:0};var g={x:110,y:0,z:0},h=this.createSprite(a,b,d,e,g);h.update(),f.addChild(h),this.sprite=f},SceneObject.prototype.setBackground=function(a,b,c,d){var e=this.sprite.children[0],f=a&&b?"background-size:"+a+"px "+b+"px;":"",g=c?"background-image:url('"+c+"');":"",h=d?"background-color:"+d+";":"",i=f||g||h?";":"";e.style.cssText+=i+f+g+h},SceneObject.prototype.rotate=function(a,b,c,d){var e=this.sprite.children[0];Sprite.prototype.rotate.call(this,a,b,c,d,e)},SceneObject.prototype.rotateTo=function(a,b,c){var d=this.sprite.children[0];Sprite.prototype.rotateTo.call(this,a,b,c,d)};